Index: class.tx_commerce_pibase.php
===================================================================
--- class.tx_commerce_pibase.php	(Revision 23216)
+++ class.tx_commerce_pibase.php	(Arbeitskopie)
@@ -121,14 +121,53 @@
 	    $this->templateCode = $this->cObj->fileResource($this->conf['templateFile']);
 	  	if (empty($this->templateCode)) {
 	  		return $this->error('init',__LINE__,"Template File not loaded, maybe it doesn't exist: ".$this->conf['templateFile']);
-	  	}		
+	  	}
 	    if ($this->conf['useRootlineInformationToUrl']) {
 			$this->useRootlineInformationToUrl = $this->conf['useRootlineInformationToUrl'];
 		}
 
 	}
-	
+
+
 	/**
+	 * Returns the payment object and includes the Payment Class. If there is no payment it throws an error
+	 *
+	 * @return paymentObj
+	 */
+	function getPaymentObject($paymentType = '') {
+		$sysConfig = $GLOBALS['TYPO3_CONF_VARS']['EXTCONF'][$this->extKey]['SYSPRODUCTS']['PAYMENT'];
+
+		$config = $sysConfig['types'][strtolower((string)$paymentType)];
+
+		$errorStr = NULL;
+		if (!isset($config)) {
+			$errorStr[] = 'config for payment not set!:' . $paymentType;
+		}
+
+		if (!isset($config['class'])) {
+			$errorStr[] = 'class not set!:'. $config['class'];
+		}
+
+		if (!file_exists($config['path'])){
+			$errorStr[] = 'file not found!:'. $config['path'];
+		}
+
+		if (is_array($errorStr)) {
+			die ('MAIN:FATAL! No payment possible because I don\'t know how to handle it! (' . implode(', ', $errorStr) . ')');
+		}
+
+		require_once($config['path']);
+		$paymentObjClassName = t3lib_div::makeInstanceClassName($config['class']);
+		$paymentObj = new $paymentObjClassName($this);
+		// @TODO is this needed?
+		if (method_exists($paymentObj, 'setStep'))	{
+			$this->piVars['step'] = $paymentObj->setStep($_REQUEST, $this->piVars['step']);
+		}
+		return $paymentObj;
+	}
+
+
+	/**
 	 * Getting additional locallang-files through an Hook
 	 */
 	function addAdditionalLocallang() {
